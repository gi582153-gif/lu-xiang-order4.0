<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ»·é¦™é¥Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; padding-bottom: 120px; touch-action: manipulation; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #92400e; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #closed-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; color: white; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        /* é˜²æ­¢æŒ‰éˆ•è¢«é›™æ“Šé¸å– */
        button { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="closed-overlay">
        <div class="text-6xl mb-4">ğŸ˜´</div><h2 class="text-3xl font-bold mb-2">æœ¬åº—ä¼‘æ¯ä¸­</h2><p class="text-gray-300">è«‹æ–¼ç‡Ÿæ¥­æ™‚é–“å†ä¾†å…‰è‡¨</p>
    </div>

    <header class="bg-amber-800 text-white p-4 shadow-md sticky top-0 z-20">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold mr-2">æ»·é¦™é¥Œ</h1>
                <span id="shop-status-light" class="w-3 h-3 rounded-full bg-green-400 border border-white shadow-[0_0_8px_#4ade80]"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openHistoryModal()" class="text-xs bg-amber-700 hover:bg-amber-600 border border-amber-600 px-2 py-1 rounded flex items-center">ğŸ“œ æŸ¥å–®</button>
                <div id="liff-status" class="text-xs bg-amber-900 px-2 py-1 rounded text-gray-300 hidden"></div>
                <button id="liff-login-btn" onclick="liff.login()" class="hidden bg-[#06C755] hover:bg-[#05b34c] text-white text-xs px-2 py-1 rounded font-bold shadow">LINE ç™»å…¥</button>
            </div>
        </div>
        <div class="flex justify-between items-center mt-2">
            <div class="text-xs opacity-90">â³ ç­‰å¾…ï¼š<span id="wait-time-display">--</span> åˆ†</div>
            <div class="bg-amber-700 px-2 py-1 rounded text-sm flex items-center gap-2">
                <span>æ­£åœ¨é»ï¼š<span id="current-order-num" class="font-bold text-yellow-300">ç¬¬ 1 ä½</span></span>
                <button onclick="finishCurrentPerson()" class="bg-yellow-500 hover:bg-yellow-600 text-amber-900 px-2 py-0.5 rounded text-xs font-bold shadow active:scale-95 transition-transform">+ åŠ ä¸‹ä¸€ä½</button>
            </div>
        </div>
    </header>

    <div id="loading" class="text-center py-10">
        <div class="loader"></div>
        <p class="text-gray-500">æ­£åœ¨é€£ç·šèœå–®...</p>
    </div>
    <div id="menu-container" class="p-4 max-w-md mx-auto hidden"></div>

    <div class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_15px_rgba(0,0,0,0.1)] p-4 border-t border-gray-200 z-30">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div><p class="text-xs text-gray-500">åœ˜è³¼ç¸½è¨ˆ (<span id="total-person-count">1</span>äºº)</p><p class="text-2xl font-bold text-amber-600" id="total-price">NT$0</p></div>
            <button onclick="openOrderModal()" class="bg-amber-800 hover:bg-amber-900 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center active:scale-95 transition-transform">ğŸ›’ çµå¸³</button>
        </div>
    </div>

    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-end sm:items-center justify-center z-50">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:rounded-xl rounded-t-2xl shadow-2xl flex flex-col relative">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h2 class="text-lg font-bold text-gray-800">ç¢ºèªè¨‚å–®å…§å®¹</h2>
                <button onclick="closeModal('order-modal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto p-4 flex-1 space-y-6">
                <div class="bg-amber-50 p-1 rounded-lg flex text-sm font-bold">
                    <button onclick="setOrderType('pickup')" id="btn-pickup" class="flex-1 py-2 rounded-md shadow bg-white text-amber-800">ğŸ¥¡ è‡ªå–</button>
                    <button onclick="setOrderType('delivery')" id="btn-delivery" class="flex-1 py-2 rounded-md text-gray-500">ğŸ›µ å¤–é€ (æ»¿$300)</button>
                </div>
                <div class="space-y-3">
                    <div class="flex space-x-2">
                        <input type="text" id="cust-name" placeholder="è¨‚è³¼äººç¨±å‘¼ *" class="w-1/2 p-2 border rounded bg-gray-50 focus:bg-white">
                        <input type="tel" id="cust-phone" placeholder="è¯çµ¡é›»è©± *" class="w-1/2 p-2 border rounded bg-gray-50 focus:bg-white">
                    </div>
                    <div id="address-field" class="hidden">
                        <input type="text" id="cust-address" placeholder="å¤–é€åœ°å€ *" class="w-full p-2 border rounded bg-gray-50 focus:bg-white">
                    </div>
                </div>
                <div class="border rounded-lg bg-gray-50 overflow-hidden">
                    <div class="bg-gray-200 px-3 py-2 text-xs text-gray-600 font-bold">åœ˜è³¼æ˜ç´°</div>
                    <div id="order-list" class="text-sm p-3 space-y-3 max-h-60 overflow-y-auto"></div>
                </div>
                <textarea id="cust-note" placeholder="æ•´å–®å‚™è¨»..." class="w-full p-2 border rounded text-sm h-16 bg-gray-50 focus:bg-white"></textarea>
                <div class="flex justify-between items-end border-t pt-4">
                    <span class="text-gray-600">ç¸½é‡‘é¡</span><span class="text-3xl font-bold text-amber-700" id="modal-total">NT$0</span>
                </div>
            </div>
            <div class="p-4 border-t bg-white">
                <button id="submit-btn" onclick="submitOrder()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-green-700 transition">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white w-full max-w-md h-[80vh] rounded-xl shadow-2xl flex flex-col p-4">
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                <h2 class="text-xl font-bold text-amber-800">ğŸ“œ æ­·å²ç´€éŒ„ (æœ¬æ©Ÿ)</h2>
                <button onclick="closeModal('history-modal')" class="text-2xl text-gray-400">&times;</button>
            </div>
            <div id="history-content" class="overflow-y-auto flex-1 space-y-3">
                <p class="text-gray-400 text-center mt-10">å°šç„¡è¨‚å–®ç´€éŒ„</p>
            </div>
            <button onclick="localStorage.removeItem('orderHistory'); openHistoryModal();" class="mt-2 text-xs text-gray-400 underline self-center">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <div id="options-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[60]">
        <div class="bg-white w-80 rounded-lg p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center border-b pb-2">è¨­å®šå£å‘³ (<span id="opt-person-num"></span>)</h3>
            <p class="font-bold text-amber-800 mb-2 text-sm">ğŸŒ¶ï¸ è¾£åº¦</p>
            <div class="grid grid-cols-4 gap-2 text-sm mb-4">
                <label class="cursor-pointer border rounded p-1 text-center hover:bg-amber-50"><input type="radio" name="temp-spicy" value="ä¸è¾£" checked><div>ä¸è¾£</div></label>
                <label class="cursor-pointer border rounded p-1 text-center hover:bg-amber-50"><input type="radio" name="temp-spicy" value="å°è¾£"><div>å°è¾£</div></label>
                <label class="cursor-pointer border rounded p-1 text-center hover:bg-amber-50"><input type="radio" name="temp-spicy" value="ä¸­è¾£"><div>ä¸­è¾£</div></label>
                <label class="cursor-pointer border rounded p-1 text-center hover:bg-amber-50"><input type="radio" name="temp-spicy" value="å¤§è¾£"><div>å¤§è¾£</div></label>
            </div>
            <p class="font-bold text-amber-800 mb-2 text-sm">ğŸ§„ ä½æ–™ (é è¨­å…¨åŠ )</p>
            <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                <label class="flex items-center space-x-1"><input type="checkbox" name="temp-condiment" value="é…¸èœ" checked><span>é…¸èœ</span></label>
                <label class="flex items-center space-x-1"><input type="checkbox" name="temp-condiment" value="è”¥èŠ±" checked><span>è”¥èŠ±</span></label>
                <label class="flex items-center space-x-1"><input type="checkbox" name="temp-condiment" value="è’œæ³¥" checked><span>è’œæ³¥</span></label>
                <label class="flex items-center space-x-1"><input type="checkbox" name="temp-condiment" value="èƒ¡æ¤’" checked><span>èƒ¡æ¤’</span></label>
            </div>
            <button onclick="confirmPersonOptions()" class="w-full bg-amber-800 text-white py-2 rounded font-bold">ç¢ºèªåŠ å…¥</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸŸ¢ ç¶²å€èˆ‡ ID å€
        // ==========================================
        const menuCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfQ9x4tLrKSwm1WNhswVJyKYhYr3ephHrEeja7STTtSv6G_MUjfJa9MN8X6DuSgDYjtYmNX9sAqEsM/pub?gid=127414704&single=true&output=csv";
        const configCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfQ9x4tLrKSwm1WNhswVJyKYhYr3ephHrEeja7STTtSv6G_MUjfJa9MN8X6DuSgDYjtYmNX9sAqEsM/pub?gid=1561447100&single=true&output=csv";
        const scriptUrl = "https://script.google.com/macros/s/AKfycbzzF0XfnyIfVa1gc9I7fvUaEJiQW8xyuiGlWPXkFOhIVNJ1O52Lpwx6ipmmHNoPkmbvew/exec";
        
        // ğŸŸ¢ é€™æ˜¯ä½ çš„ LIFF ID
        const LIFF_ID = "2009008890-ktXXza53"; 
        // ==========================================

        let menuData = []; let currentCart = {}; let confirmedOrders = [];
        let config = { status: 'OPEN', base_time: 20 }; let currentOrderType = 'pickup';
        let customerLineId = "";
        let isProcessing = false; // ğŸ”´ é˜²æ‰‹æŠ–é–‹é—œ

        function init() {
            // ğŸ”´ æ¯æ—¥æ­¸é›¶æª¢æŸ¥ï¼šå¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼ŒæŠŠå–®è™Ÿé‡ç½®
            checkDailyReset();

            initializeLiff();
            loadUserData();
            Papa.parse(configCsvUrl, { download: true, header: true, complete: res => {
                if(res.data.length>0) res.data.forEach(r => { if(r.key) config[r.key] = r.value; });
                checkShopStatus();
            }, error: ()=>checkShopStatus()});

            Papa.parse(menuCsvUrl, { download: true, header: true, complete: res => {
                if (res.data && res.data.length > 0) processMenu(res.data);
                else document.getElementById('loading').innerHTML = "<p class='text-red-500'>èœå–®è®€å–å¤±æ•—</p>";
            }, error: ()=>document.getElementById('loading').innerHTML = "<p class='text-red-500'>é€£ç·šå¤±æ•—</p>"});
            
            updateWaitTimeDisplay();
        }

        // ğŸŸ¢ æ¯æ—¥æ­¸é›¶åŠŸèƒ½
        function checkDailyReset() {
            const today = new Date().toLocaleDateString();
            const savedDate = localStorage.getItem('lastRunDate');
            if (savedDate !== today) {
                localStorage.setItem('dailyCount', 0); // æ­¸é›¶
                localStorage.setItem('lastRunDate', today);
                console.log("æ–°çš„ä¸€å¤©ï¼Œå–®è™Ÿå·²æ­¸é›¶ï¼");
            }
        }

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    customerLineId = profile.userId;
                    document.getElementById('liff-status').innerText = `âœ… ${profile.displayName}`;
                    document.getElementById('liff-status').classList.remove('hidden');
                    document.getElementById('liff-login-btn').classList.add('hidden');
                    if(!document.getElementById('cust-name').value) document.getElementById('cust-name').value = profile.displayName;
                } else {
                    document.getElementById('liff-login-btn').classList.remove('hidden');
                }
            } catch (err) { console.error('LIFF Error', err); }
        }

        function saveOrderToHistory(orderData) {
            let history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            orderData.timestamp = new Date().toLocaleString();
            history.unshift(orderData);
            if(history.length > 10) history.pop();
            localStorage.setItem('orderHistory', JSON.stringify(history));
        }

        function openHistoryModal() {
            const history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            const container = document.getElementById('history-content');
            if(history.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center mt-10">å°šç„¡è¨‚å–®ç´€éŒ„

