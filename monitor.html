<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»·é¦™é¥Œ - è‡ªå‹•æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .box { border: 1px solid #444; padding: 20px; margin-bottom: 20px; background: #000; }
        .log { color: #888; font-size: 12px; height: 300px; overflow-y: auto; border-top: 1px solid #333; margin-top: 10px; }
        @media print { .no-print { display: none; } body { background: white; color: black; margin: 0; padding: 0; } }
        /* æ”¶æ“šæ¨£å¼ */
        .receipt { display: none; width: 100%; max-width: 300px; font-family: 'Noto Sans TC', sans-serif; font-size: 14px; }
        @media print { .receipt { display: block; } }
        .r-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .r-big { font-size: 24px; font-weight: 900; }
        .r-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .r-sub { font-weight: bold; background: #eee; padding: 2px; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="box">
            <h2>ğŸ–¨ï¸ è‡ªå‹•å‡ºå–®ç³»çµ±</h2>
            <div id="status">ç­‰å¾…å•Ÿå‹•...</div>
            <div style="margin-top:10px;">æœ€æ–°å–®è™Ÿï¼š<span id="last-id" style="font-weight:bold; color:white;">--</span></div>
            <button onclick="start()" style="margin-top:20px; padding:10px 20px; font-size:16px; cursor:pointer;">â–¶ï¸ å•Ÿå‹•è‡ªå‹•æ¥å–®</button>
            <div class="log" id="log"></div>
        </div>
    </div>

    <div id="print-area" class="receipt"></div>

    <script>
        // ğŸŸ¢ é€™è£¡è²¼ä¸Šä½ çš„ ORDERS CSV ç¶²å€ (ä¸æ˜¯ MENU å–”ï¼)
        // è«‹å»è©¦ç®—è¡¨ -> orders åˆ†é  -> ç™¼å¸ƒåˆ°ç¶²è·¯ -> è¤‡è£½ CSV ç¶²å€
        const ordersCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfQ9x4tLrKSwm1WNhswVJyKYhYr3ephHrEeja7STTtSv6G_MUjfJa9MN8X6DuSgDYjtYmNX9sAqEsM/pub?gid=0&single=true&output=csv"; // âš ï¸ è«‹æ›æˆä½ çš„ Orders CSV ç¶²å€ (gidé€šå¸¸ä¸æ˜¯0)

        let lastId = localStorage.getItem('lastPrintId') || "ç„¡";
        let isRunning = false;

        document.getElementById('last-id').innerText = lastId;

        function start() {
            if(isRunning) return;
            isRunning = true;
            document.getElementById('status').innerText = "ğŸŸ¢ ç›£æ§ä¸­ (æ¯ 5 ç§’æª¢æŸ¥)";
            document.getElementById('status').style.color = "#0f0";
            setInterval(checkOrders, 5000);
            checkOrders();
        }

        function checkOrders() {
            const url = ordersCsvUrl + "&t=" + Date.now();
            Papa.parse(url, {
                download: true, header: false,
                complete: function(res) {
                    let rows = res.data.filter(r => r[0] && r[0].startsWith('#'));
                    if (rows.length === 0) return;
                    
                    let newOrder = rows[rows.length - 1]; // æŠ“æœ€å¾Œä¸€ç­†
                    let id = newOrder[0];
                    
                    if (id !== lastId) {
                        log(`ç™¼ç¾æ–°è¨‚å–®: ${id}`);
                        lastId = id;
                        localStorage.setItem('lastPrintId', id);
                        document.getElementById('last-id').innerText = id;
                        
                        try {
                            let jsonStr = newOrder[8]; // å‡è¨­ JSON åœ¨ç¬¬ I æ¬„ (ç´¢å¼•8)
                            print(JSON.parse(jsonStr));
                        } catch(e) {
                            log("è§£æå¤±æ•—ï¼Œå˜—è©¦å°ç°¡æ˜“ç‰ˆ");
                            printSimple(newOrder);
                        }
                    }
                }
            });
        }

        function print(data) {
            let html = `
                <div class="r-header">
                    <div class="r-big">æ»·é¦™é¥Œ</div>
                    <div>å–®è™Ÿï¼š<span class="r-big">${data.id.replace('#','')}</span></div>
                    <div>${data.type} / ${data.eta} å–é¤</div>
                </div>
                <div>${data.name} / ${data.phone}</div>
                ${data.address ? `<div>ğŸ“ ${data.address}</div>` : ''}
                <div style="border-bottom:1px solid #000; margin:5px 0;"></div>
            `;
            
            if(data.subOrders) {
                data.subOrders.forEach((sub, i) => {
                    html += `<div class="r-sub">ğŸ‘¤ P${i+1} (${sub.spicy}/${sub.condiment})</div>`;
                    sub.items.forEach(item => {
                        html += `<div class="r-item"><span>${item.name}</span><span>x${item.qty}</span></div>`;
                    });
                });
            }

            html += `
                <div style="border-top:2px dashed #000; margin-top:10px; padding-top:5px; font-size:20px; font-weight:bold; display:flex; justify-content:space-between;">
                    <span>ç¸½è¨ˆ</span><span>$${data.total}</span>
                </div>
                <div style="margin-top:5px; font-size:12px;">å‚™è¨»ï¼š${data.note||'ç„¡'}</div>
                <div style="text-align:center; margin-top:10px; font-size:12px;">-- è¬è¬å…‰è‡¨ --</div>
            `;
            
            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => window.print(), 500);
        }

        function printSimple(row) {
            document.getElementById('print-area').innerHTML = `
                <div class="r-header"><div class="r-big">æ»·é¦™é¥Œ</div><div>å–®è™Ÿï¼š${row[0]}</div></div>
                <div>${row[7]}</div>
                <div class="r-big">ç¸½é‡‘é¡ï¼š${row[6]}</div>
            `;
            setTimeout(() => window.print(), 500);
        }

        function log(msg) {
            let d = new Date().toLocaleTimeString();
            document.getElementById('log').innerHTML = `<div>[${d}] ${msg}</div>` + document.getElementById('log').innerHTML;
        }
    </script>
</body>
</html>
  
