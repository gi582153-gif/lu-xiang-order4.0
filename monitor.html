<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background: #222; color: #0f0; font-family: monospace; padding: 20px; }
        .box { border: 1px solid #444; padding: 20px; margin-bottom: 20px; }
        @media print { .no-print { display: none; } body { background: white; color: black; } }
    </style>
</head>
<body>
    <div class="no-print">
        <div class="box">
            <h2>ğŸ–¨ï¸ è‡ªå‹•æ¥å–®ä¸­... <span id="status" style="color:yellow">é€£ç·šä¸­</span></h2>
            <p>æœ€æ–°å–®è™Ÿï¼š<span id="last-id" style="color:white; font-weight:bold">ç„¡</span></p>
        </div>
        <button onclick="init()" style="padding:10px 20px; font-size:16px; cursor:pointer;">â–¶ï¸ é»æ­¤å•Ÿå‹•ç›£æ§</button>
    </div>

    <div id="print-area"></div>

    <script>
        // ==========================================
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ç­†è¨˜æœ¬ç¶²å€
        // ==========================================
        const URL_ORDERS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfQ9x4tLrKSwm1WNhswVJyKYhYr3ephHrEeja7STTtSv6G_MUjfJa9MN8X6DuSgDYjtYmNX9sAqEsM/pub?gid=1858812803&single=true&output=csv
"; 
        // ==========================================

        let lastId = localStorage.getItem('lastId');
        document.getElementById('last-id').innerText = lastId || 'ç„¡';

        function init() {
            document.getElementById('status').innerText = "ğŸŸ¢ ç›£æ§ä¸­";
            setInterval(check, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
            check();
        }

        function check() {
            // åŠ æ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–
            Papa.parse(URL_ORDERS + "&t=" + Date.now(), {
                download: true, header: false,
                complete: function(res) {
                    let rows = res.data.filter(r => r[0] && r[0] !== 'å–®è™Ÿ');
                    if(rows.length === 0) return;
                    
                    let newOrder = rows[rows.length - 1]; // æŠ“æœ€å¾Œä¸€ç­†
                    let newId = newOrder[0];
                    let jsonStr = newOrder[8]; // Iæ¬„çš„JSON

                    if(newId !== lastId) {
                        lastId = newId;
                        localStorage.setItem('lastId', newId);
                        document.getElementById('last-id').innerText = newId;
                        
                        try {
                            print(JSON.parse(jsonStr));
                        } catch(e) {
                            console.log("JSONè§£æå¤±æ•—ï¼Œç•¥éåˆ—å°");
                        }
                    }
                }
            });
        }

        function print(data) {
            let html = `<div style="text-align:center; font-size:24px; font-weight:bold; margin-bottom:10px;">æ»·é¦™é¥Œ</div>
                        <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px;">å–®è™Ÿï¼š${data.id}<br>${data.eta} å–é¤</div>
                        <div style="margin-top:5px; font-size:18px;">${data.type} / ${data.name}</div>
                        <div>é›»è©±ï¼š${data.phone}</div>
                        ${data.type==='å¤–é€'?`<div>åœ°å€ï¼š${data.address}</div>`:''}
                        <div>å‚™è¨»ï¼š${data.note}</div>
                        <hr style="border-top: 1px dashed #000;">`;
            
            if(data.subOrders) {
                data.subOrders.forEach((sub, i) => {
                    html += `<div style="font-weight:bold; margin-top:5px;">ğŸ‘¤ ç¬¬ ${i+1} ä½ (${sub.spicy}/${sub.condiment})</div>`;
                    sub.items.forEach(item => html += `<div style="display:flex; justify-content:space-between;"><span>${item.name} x${item.qty}</span></div>`);
                });
            }
            
            html += `<hr style="border-top: 1px dashed #000;">
                     <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:bold;"><span>ç¸½é‡‘é¡</span><span>$${data.total}</span></div>`;
            
            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => window.print(), 500);
        }
    </script>
</body>
</html>
