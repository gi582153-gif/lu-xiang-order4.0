<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»·é¦™é¥Œ - è‡ªå‹•æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .status-box { border: 1px solid #444; padding: 15px; margin-bottom: 20px; background: #000; }
        .status-header { font-size: 20px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .log-area { height: 300px; overflow-y: auto; font-size: 13px; color: #ccc; border-top: 1px dotted #333; padding-top: 10px; }
        button { font-size: 18px; padding: 8px 20px; cursor: pointer; background: #006600; color: white; border: none; border-radius: 4px; }
        button:hover { background: #008800; }
        
        /* ç†±æ„Ÿæ‡‰ç´™åˆ—å°æ¨£å¼ (58mm / 80mm) */
        @media print {
            @page { margin: 0; }
            body { background: white; color: black; margin: 0; padding: 0; width: 100%; }
            .no-print { display: none !important; }
            .receipt { display: block !important; padding: 5px 10px; font-family: 'Noto Sans TC', sans-serif; font-size: 14px; }
            .section { border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
            .item { display: flex; justify-content: space-between; }
        }
        .receipt { display: none; } 
    </style>
</head>
<body>

    <div class="no-print">
        <div class="status-box">
            <div class="status-header">
                <span>ğŸ–¨ï¸ æ¥å–®ç³»çµ±ç›£æ§</span>
                <span id="connection-status" style="color:yellow;">ç­‰å¾…å•Ÿå‹•...</span>
            </div>
            <div>ç›®å‰æœ€æ–°å–®è™Ÿï¼š<span id="current-id" style="font-weight:bold; color: white;">å°šæœªè®€å–</span></div>
            <div style="margin-top:5px; font-size:12px; color:#888;">æœ€å¾Œæª¢æŸ¥æ™‚é–“ï¼š<span id="last-update">--:--:--</span></div>
        </div>

        <button onclick="startMonitor()" id="start-btn">â–¶ï¸ å•Ÿå‹•è‡ªå‹•æ¥å–®</button>
        <button onclick="testPrint()" style="background:#555; margin-left:10px;">ğŸ–¨ï¸ æ¸¬è©¦åˆ—å°</button>
        
        <h3 style="margin-top:20px; border-bottom:1px solid #333; padding-bottom:5px;">ç³»çµ±ç´€éŒ„</h3>
        <div class="log-area" id="log-area"></div>
    </div>

    <div id="receipt-area" class="receipt"></div>

    <script>
        // ==========================================
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ [Orders] åˆ†é  CSV ç¶²å€
        // âš ï¸ ä½ çš„ orders åˆ†é  ID æ‡‰è©²è·Ÿ config ä¸ä¸€æ¨£ï¼Œè«‹å»ç¢ºèªä¸€ä¸‹ï¼
        // ==========================================
        const ordersCsvUrl = "ä½ çš„_Orders_åˆ†é _CSV_ç¶²å€"; 
        // ğŸ‘† è¨˜å¾—ç¢ºèªçµå°¾è¦æ˜¯ output=csv
        // ==========================================

        let lastOrderId = localStorage.getItem('lastPrintedId') || "ç„¡";
        let isRunning = false;
        let checkInterval;

        document.getElementById('current-id').innerText = lastOrderId;

        function startMonitor() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('start-btn').innerText = "ğŸŸ¢ ç›£æ§ä¸­ (è«‹ä¿æŒè¦–çª—é–‹å•Ÿ)";
            document.getElementById('start-btn').style.background = "#004400";
            document.getElementById('start-btn').disabled = true;
            
            log("ç³»çµ±å•Ÿå‹•ï¼Œé–‹å§‹é€£æ¥ Google è©¦ç®—è¡¨...");
            checkOrders(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            checkInterval = setInterval(checkOrders, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        function checkOrders() {
            // åŠ å…¥æ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–
            const cacheBusterUrl = ordersCsvUrl + (ordersCsvUrl.includes('?') ? '&' : '?') + "t=" + new Date().getTime();

            Papa.parse(cacheBusterUrl, {
                download: true,
                header: false, // ä¸ä½¿ç”¨æ¨™é¡Œåˆ—æ¨¡å¼ï¼Œç›´æ¥æŠ“æœ€å¾Œä¸€è¡Œ
                complete: function(results) {
                    document.getElementById('connection-status').innerText = "ğŸŸ¢ é€£ç·šæ­£å¸¸";
                    document.getElementById('connection-status').style.color = "#00ff00";
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString();

                    let rows = results.data;
                    // éæ¿¾ç©ºè¡Œ
                    rows = rows.filter(r => r && r.length > 0 && r[0] !== '');
                    
                    if (rows.length === 0) {
                        log("è©¦ç®—è¡¨æ˜¯ç©ºçš„");
                        return;
                    }

                    // æŠ“æœ€å¾Œä¸€ç­†è¨‚å–®
                    let lastRow = rows[rows.length - 1];
                    
                    // æ’é™¤æ¨™é¡Œè¡Œ (å¦‚æœåªæœ‰æ¨™é¡Œ)
                    if (lastRow[0] === "å–®è™Ÿ") return;

                    let serverId = lastRow[0]; // Aæ¬„æ˜¯å–®è™Ÿ
                    let jsonStr = lastRow[8]; // Iæ¬„æ˜¯JSON (ç¢ºèªä½ çš„ GAS æœ‰å­˜å…¥ JSON)

                    if (serverId && serverId !== lastOrderId && serverId.startsWith("#")) {
                        log(`ğŸ”” ç™¼ç¾æ–°è¨‚å–®ï¼å–®è™Ÿï¼š${serverId}`);
                        
                        // æ›´æ–°ç‹€æ…‹
                        lastOrderId = serverId;
                        localStorage.setItem('lastPrintedId', serverId);
                        document.getElementById('current-id').innerText = serverId;

                        // å˜—è©¦è§£æä¸¦åˆ—å°
                        try {
                            if(jsonStr) {
                                let orderData = JSON.parse(jsonStr);
                                printOrder(orderData);
                            } else {
                                log("âš ï¸ è¨‚å–®ç¼ºå°‘ JSON è³‡æ–™ï¼Œåƒ…åˆ—å°ç°¡æ˜“ç‰ˆ");
                                printSimple(lastRow);
                            }
                        } catch (e) {
                            log("âŒ JSON è§£æå¤±æ•—ï¼š" + e.message);
                            printSimple(lastRow); // å¤±æ•—å°±å°ç°¡æ˜“ç‰ˆ
                        }
                    }
                },
                error: function(err) {
                    document.getElementById('connection-status').innerText = "ğŸ”´ é€£ç·šå¤±æ•—";
                    document.getElementById('connection-status').style.color = "red";
                    log("âŒ è®€å–éŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²å€æ ¼å¼): " + err.message);
                }
            });
        }

        function printOrder(data) {
            log(`ğŸ–¨ï¸ æ­£åœ¨åˆ—å°å–®è™Ÿ ${data.id}...`);
            let html = `
                <div style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:5px;">æ»·é¦™é¥Œ</div>
                <div style="text-align:center; font-size:12px; border-bottom:1px dashed #000; padding-bottom:5px;">
                    å–®è™Ÿï¼š<span style="font-size:16px; font-weight:bold;">${data.id}</span><br>
                    ${data.eta} å–é¤
                </div>
                <div class="section" style="margin-top:5px;">
                    <div style="font-size:16px; font-weight:bold;">${data.type}</div>
                    <div>${data.name} / ${data.phone}</div>
                    ${data.type==='å¤–é€' ? `<div>ğŸ“ ${data.address}</div>` : ''}
                    <div>å‚™è¨»ï¼š${data.note || 'ç„¡'}</div>
                </div>
            `;
            
            if(data.subOrders) {
                data.subOrders.forEach((sub, idx) => {
                    html += `
                        <div class="section">
                            <div style="font-weight:bold;">ğŸ‘¤ ç¬¬ ${idx+1} ä½ (${sub.spicy}/${sub.condiment})</div>
                    `;
                    sub.items.forEach(item => {
                        html += `
                            <div class="item">
                                <span>${item.name} x${item.qty}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                });
            } else {
                 // ç›¸å®¹èˆŠè³‡æ–™
                 html += `<div class="section"><div>(ç„¡è©³ç´°åˆ†å–®è³‡æ–™)</div></div>`;
            }

            html += `
                <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:bold; margin-top:10px;">
                    <span>ç¸½é‡‘é¡</span>
                    <span>$${data.total}</span>
                </div>
                <div style="text-align:center; font-size:12px; margin-top:10px;">-- è¬è¬å…‰è‡¨ --</div>
            `;

            document.getElementById('receipt-area').innerHTML = html;
            setTimeout(() => { window.print(); }, 500);
        }

        function printSimple(row) {
             // å‚™ç”¨åˆ—å°æ–¹æ¡ˆ
             document.getElementById('receipt-area').innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:18px;">æ»·é¦™é¥Œ (ç°¡æ˜“å–®)</div>
                <div style="text-align:center; border-bottom:1px solid #000;">å–®è™Ÿï¼š${row[0]}</div>
                <div style="margin-top:10px;">
                    ${row[7] ? row[7].replace(/\n/g, '<br>') : 'å…§å®¹è®€å–å¤±æ•—'}
                </div>
                <div style="font-weight:bold; margin-top:10px; font-size:16px;">ç¸½é‡‘é¡ï¼š${row[6]}</div>
             `;
             setTimeout(() => window.print(), 500);
        }

        function testPrint() {
            printOrder({
                id: "#TEST", type: "æ¸¬è©¦è‡ªå–", name: "æ¸¬è©¦å“¡", phone: "0900000000",
                eta: "12:00", total: 100, note: "é€™æ˜¯æ¸¬è©¦åˆ—å°",
                subOrders: [{spicy:"å°è¾£", condiment:"é…¸èœ", items:[{name:"é´¨è¡€", qty:1}, {name:"è±†è…", qty:2}]}]
            });
        }

        function log(msg) {
            let div = document.getElementById('log-area');
            let time = new Date().toLocaleTimeString();
            div.innerHTML = `<div><span style="color:#666;">[${time}]</span> ${msg}</div>` + div.innerHTML;
        }
    </script>
</body>
</html>
