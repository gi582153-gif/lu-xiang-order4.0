<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»·é¦™é¥Œ - è‡ªå‹•æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* å¾Œå°ä»‹é¢ (é»‘è‰²è­·çœ¼) */
        body { font-family: "Courier New", monospace; background: #222; color: #0f0; padding: 20px; }
        .box { border: 2px solid #444; padding: 30px; max-width: 600px; margin: 0 auto; background: #000; text-align: center; }
        .status-dot { height: 15px; width: 15px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .status-active { background-color: #0f0; box-shadow: 0 0 10px #0f0; }
        .log { color: #888; font-size: 14px; height: 300px; overflow-y: auto; border-top: 1px solid #333; margin-top: 20px; text-align: left; padding: 10px; }
        
        /* ğŸ–¨ï¸ æ”¶æ“šæ¨£å¼ (åˆ—å°æ™‚æ‰å‡ºç¾) */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; margin: 0; padding: 0; font-family: 'Verdana', sans-serif; }
            .receipt { display: block !important; width: 100%; max-width: 300px; font-size: 14px; padding: 0; }
            .r-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
            .r-title { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
            .r-id { font-size: 32px; font-weight: 900; margin: 5px 0; border: 2px solid #000; display: inline-block; padding: 2px 10px; }
            .r-info { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
            .r-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding-left: 5px; }
            .r-sub { font-weight: bold; background: #eee; padding: 4px; margin-top: 8px; border-left: 4px solid #555; }
            .r-total { border-top: 2px dashed #000; margin-top: 10px; padding-top: 5px; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        }
        .receipt { display: none; }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="box">
            <h1>ğŸ–¨ï¸ æ»·é¦™é¥Œ è‡ªå‹•æ¥å–®æ©Ÿ</h1>
            <div style="margin-bottom: 20px;">
                <span id="status-dot" class="status-dot"></span>
                <span id="status-text">ç­‰å¾…å•Ÿå‹•...</span>
            </div>
            <div style="font-size: 20px; margin-bottom: 20px;">
                æœ€æ–°å–®è™Ÿï¼š<span id="last-id" style="font-weight:bold; color:white; font-size: 30px;">--</span>
            </div>
            <button onclick="start()" style="padding:15px 30px; font-size:20px; cursor:pointer; background: #0f0; border:none; border-radius: 5px; font-weight:bold;">â–¶ï¸ å•Ÿå‹•ç›£æ§</button>
            <button onclick="testPrint()" style="padding:15px 30px; font-size:20px; cursor:pointer; background: #fff; border:none; border-radius: 5px; font-weight:bold; margin-left: 10px;">ğŸ§ª æ¸¬è©¦åˆ—å°</button>
            <div class="log" id="log">ç³»çµ±ç´€éŒ„...</div>
        </div>
    </div>

    <div id="print-area" class="receipt"></div>

    <script>
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ ç¬¬ 1 æ­¥è¤‡è£½çš„ CSV ç¶²å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        const ordersCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfQ9x4tLrKSwm1WNhswVJyKYhYr3ephHrEeja7STTtSv6G_MUjfJa9MN8X6DuSgDYjtYmNX9sAqEsM/pubhtml?gid=1858812803&single=true";
        
        let lastId = localStorage.getItem('lastPrintId') || "#000";
        let isRunning = false;
        let checkInterval = null;

        document.getElementById('last-id').innerText = lastId;

        function start() {
            if(isRunning) return;
            isRunning = true;
            document.getElementById('status-text').innerText = "ğŸŸ¢ ç›£æ§ä¸­ (æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡)";
            document.getElementById('status-dot').classList.add('status-active');
            log("ç³»çµ±å•Ÿå‹•ï¼Œé–‹å§‹ç›£è½è¨‚å–®...");
            checkOrders();
            checkInterval = setInterval(checkOrders, 5000);
        }

        function checkOrders() {
            const url = ordersCsvUrl + "&t=" + Date.now();
            
            Papa.parse(url, {
                download: true,
                header: false,
                complete: function(res) {
                    // 1. éæ¿¾å‡ºæœ‰æ•ˆçš„è¨‚å–®åˆ— (å¿…é ˆæ˜¯ # é–‹é ­)
                    let rows = res.data.filter(r => r[0] && r[0].toString().startsWith('#'));
                    
                    if (rows.length === 0) return;

                    // ğŸ›‘ é—œéµä¿®æ­£ï¼šå¼·åˆ¶æŒ‰ç…§å–®è™Ÿæ•¸å­—å¤§å°æ’åº (å° -> å¤§)
                    // é€™æ¨£ä¿è­‰æœ€å¾Œä¸€ç­†ä¸€å®šæ˜¯ã€Œæœ€æ–°ã€æœ€å¤§ã€çš„å–®è™Ÿï¼Œä¸æœƒè·³é‡
                    rows.sort((a, b) => {
                        let numA = parseInt(a[0].replace(/\D/g, '')) || 0;
                        let numB = parseInt(b[0].replace(/\D/g, '')) || 0;
                        return numA - numB;
                    });
                    
                    // æŠ“å‡ºæœ€å¤§çš„ä¸€ç­†
                    let newOrder = rows[rows.length - 1];
                    let id = newOrder[0];
                    
                    // 2. æ¯”å°å–®è™Ÿï¼šåªæœ‰ç•¶ã€Œæ–°å–®è™Ÿã€ä¸ä¸€æ¨£æ™‚æ‰è™•ç†
                    if (id !== lastId) {
                        
                        // é¡å¤–ä¿éšªï¼šç¢ºä¿æ–°å–®è™ŸçœŸçš„æ¯”è¼ƒå¤§ (é¿å…æœ‰äººåˆªå–®å°è‡´å›æœ”)
                        let currentNum = parseInt(id.replace(/\D/g, '')) || 0;
                        let lastNum = parseInt(lastId.replace(/\D/g, '')) || 0;
                        
                        // å¦‚æœæ˜¯æ–°çš„ä¸€å¤© (#001)ï¼Œæˆ–è€…æ˜¯è™Ÿç¢¼æ¯”è¼ƒå¤§ï¼Œéƒ½ç®—æ–°å–®
                        if (currentNum > lastNum || (currentNum === 1 && lastNum > 10)) {
                             log(`ğŸ”” ç™¼ç¾æ–°è¨‚å–®: ${id}`);
                             lastId = id;
                             localStorage.setItem('lastPrintId', id);
                             document.getElementById('last-id').innerText = id;
                             
                             try {
                                 let jsonStr = newOrder[8]; 
                                 if(jsonStr) printReceipt(JSON.parse(jsonStr));
                                 else printSimple(newOrder);
                             } catch(e) {
                                 printSimple(newOrder);
                             }
                        }
                    }
                },
                error: function(err) { log("âŒ é€£ç·šéŒ¯èª¤ï¼š" + err); }
            });
        }

        function printReceipt(data) {
            let html = `
                <div class="r-header">
                    <div class="r-title">æ»·é¦™é¥Œ</div>
                    <div class="r-id">${data.id.replace('#','')}</div>
                    <div class="r-info">${data.type} / ${data.eta} å–é¤</div>
                </div>
                <div style="font-size:18px; font-weight:bold;">${data.name}</div>
                <div>${data.phone}</div>
                ${data.address ? `<div>ğŸ“ ${data.address}</div>` : ''}
                <div style="border-bottom:2px solid #000; margin:10px 0;"></div>
            `;
            
            if(data.subOrders) {
                data.subOrders.forEach((sub, i) => {
                    html += `<div class="r-sub">ğŸ‘¤ ç¬¬ ${i+1} ä½ (${sub.spicy}/${sub.condiment})</div>`;
                    sub.items.forEach(item => {
                        html += `<div class="r-item"><span>${item.name}</span><span>x${item.qty}</span></div>`;
                    });
                });
            }

            html += `
                <div class="r-total">
                    <span>ç¸½è¨ˆ</span><span>$${data.total}</span>
                </div>
                <div style="margin-top:10px; font-size:14px; border: 1px solid #000; padding: 5px;">
                    <b>å‚™è¨»ï¼š</b><br>${data.note || 'ç„¡'}
                </div>
                <div style="text-align:center; margin-top:15px; font-size:12px;">-- è¬è¬å…‰è‡¨ --</div>
                <div style="text-align:center; font-size:10px;">${new Date().toLocaleString()}</div>
            `;
            
            document.getElementById('print-area').innerHTML = html;
            log("ğŸ–¨ï¸ æ­£åœ¨åˆ—å°å–®è™Ÿ " + data.id);
            setTimeout(() => { window.print(); }, 500);
        }

        function printSimple(row) {
            document.getElementById('print-area').innerHTML = `<div class="r-header"><div class="r-title">æ»·é¦™é¥Œ</div></div><h1>${row[0]}</h1><h2>${row[1]}</h2><p>${row[2]} / ${row[3]}</p><hr><pre style="font-size:16px;">${row[7]}</pre><hr><h1>ç¸½è¨ˆï¼š${row[6]}</h1>`;
            setTimeout(() => window.print(), 500);
        }

        function testPrint() { printReceipt({ id: "#æ¸¬è©¦", type: "è‡ªå–", eta: "12:00", name: "æ¸¬è©¦å“¡", phone: "0900", total: 100, note: "æ¸¬è©¦åˆ—å°", subOrders: [{ spicy: "å°è¾£", condiment: "å…¨åŠ ", items: [{name: "æ¸¬è©¦å“é …", qty: 1}] }] }); }
        function log(msg) { let d = new Date().toLocaleTimeString(); let p = document.createElement('div'); p.innerText = `[${d}] ${msg}`; let box = document.getElementById('log'); box.prepend(p); }
    </script>
</body>
</html>
