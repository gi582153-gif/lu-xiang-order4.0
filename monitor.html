<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»·é¦™é¥Œ - è‡ªå‹•æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .status { font-size: 24px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .log { font-size: 14px; color: #ccc; }
        button { font-size: 20px; padding: 10px 20px; cursor: pointer; background: #004400; color: white; border: none; }
        
        /* åˆ—å°æ¨£å¼ (ç†±æ„Ÿæ‡‰ç´™) */
        @media print {
            @page { margin: 0; }
            body { background: white; color: black; margin: 0; padding: 5px; width: 58mm; font-size: 14px; }
            .no-print { display: none !important; }
            .receipt { display: block !important; }
        }
        .receipt { display: none; } /* å¹³å¸¸éš±è—æ”¶æ“šå…§å®¹ */
        .item { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .section { border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="status">
            ğŸ–¨ï¸ è‡ªå‹•æ¥å–®ç›£æ§ä¸­... <span id="last-update"></span><br>
            ç›®å‰æœ€æ–°å–®è™Ÿï¼š<span id="current-id" style="color: yellow;">è®€å–ä¸­...</span>
        </div>
        <button onclick="startMonitor()">ğŸ”´ é»æ­¤é–‹å§‹æ¥æ”¶è¨‚å–®</button>
        <div class="log" id="log-area"></div>
    </div>

    <div id="receipt-area" class="receipt"></div>

    <script>
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ orders åˆ†é  CSV ç¶²å€
        const ordersCsvUrl = "ä½ çš„_orders_åˆ†é _CSV_ç¶²å€";

        let lastOrderId = localStorage.getItem('lastPrintedId') || "ç„¡";
        let isRunning = false;
        let checkInterval;

        document.getElementById('current-id').innerText = lastOrderId;

        function startMonitor() {
            if (isRunning) return;
            isRunning = true;
            document.querySelector('button').innerText = "ğŸŸ¢ ç›£æ§ä¸­ (è«‹å‹¿é—œé–‰è¦–çª—)";
            log("ç³»çµ±å•Ÿå‹•ï¼Œæ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡...");
            
            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡ï¼Œç„¶å¾Œè¨­å®šå®šæ™‚å™¨
            checkOrders();
            checkInterval = setInterval(checkOrders, 5000);
        }

        function checkOrders() {
            document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
            
            Papa.parse(ordersCsvUrl, {
                download: true,
                header: false, // å› ç‚ºæ¨™é¡Œè¡Œå¯èƒ½è®Šå‹•ï¼Œæˆ‘å€‘ç›´æ¥ç”¨ç´¢å¼•
                complete: function(results) {
                    let rows = results.data;
                    // éæ¿¾æ‰ç©ºè¡Œå’Œæ¨™é¡Œ (å‡è¨­ç¬¬ä¸€æ¬„æ˜¯å–®è™Ÿ)
                    // æˆ‘å€‘æŠ“æœ€å¾Œä¸€ç­†è³‡æ–™
                    let lastRow = rows[rows.length - 1];
                    if (!lastRow || lastRow[0] === "å–®è™Ÿ") return; // æ²’è³‡æ–™

                    let serverId = lastRow[0]; // å–®è™Ÿåœ¨ç¬¬1æ¬„ (Aæ¬„)
                    let jsonStr = lastRow[8]; // JSONè©³ç´°è³‡æ–™åœ¨ç¬¬9æ¬„ (Iæ¬„)ï¼Œè¨˜å¾— GAS é‚£é‚Šè¦å­˜é€²å»

                    // å¦‚æœç™¼ç¾æ–°å–®è™Ÿ (æ¯”ç¾åœ¨è¨˜éŒ„çš„å–®è™Ÿå¤§ï¼Œæˆ–æ˜¯ä¸ä¸€æ¨£)
                    if (serverId !== lastOrderId && serverId.startsWith("#")) {
                        log(`ç™¼ç¾æ–°è¨‚å–®ï¼å–®è™Ÿï¼š${serverId}`);
                        lastOrderId = serverId;
                        localStorage.setItem('lastPrintedId', serverId);
                        document.getElementById('current-id').innerText = serverId;

                        // åŸ·è¡Œåˆ—å°
                        try {
                            let orderData = JSON.parse(jsonStr);
                            printOrder(orderData);
                        } catch (e) {
                            log("è§£æè¨‚å–®éŒ¯èª¤ï¼Œå˜—è©¦åˆ—å°ç°¡æ˜“ç‰ˆ...");
                            // å¦‚æœ JSON è§£æå¤±æ•—ï¼Œè‡³å°‘å°å‡º Excel è£¡çš„æ–‡å­—
                            printSimple(lastRow);
                        }
                    }
                }
            });
        }

        function printOrder(data) {
            let html = `
                <div style="text-align:center; font-size:18px; font-weight:bold;">æ»·é¦™é¥Œ</div>
                <div style="text-align:center; font-size:12px; border-bottom:1px dashed #000; padding-bottom:5px;">
                    å–®è™Ÿï¼š${data.id}<br>æ™‚é–“ï¼š${data.eta} å–é¤
                </div>
                <div class="section">
                    <div>é¡å‹ï¼š${data.type}</div>
                    <div>å§“åï¼š${data.name}</div>
                    <div>é›»è©±ï¼š${data.phone}</div>
                    ${data.type==='å¤–é€' ? `<div>åœ°å€ï¼š${data.address}</div>` : ''}
                    <div>å‚™è¨»ï¼š${data.note || 'ç„¡'}</div>
                </div>
            `;

            data.subOrders.forEach((sub, idx) => {
                html += `
                    <div class="section">
                        <div style="font-weight:bold;">ç¬¬ ${idx+1} ä½ (${sub.spicy}/${sub.condiment})</div>
                `;
                sub.items.forEach(item => {
                    html += `
                        <div class="item">
                            <span>${item.name} x${item.qty}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            });

            html += `
                <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:bold; margin-top:10px;">
                    <span>ç¸½é‡‘é¡</span>
                    <span>$${data.total}</span>
                </div>
                <div style="text-align:center; font-size:12px; margin-top:10px;">-- å®Œ --</div>
            `;

            document.getElementById('receipt-area').innerHTML = html;
            
            // è§¸ç™¼åˆ—å°
            setTimeout(() => {
                window.print();
            }, 500);
        }
        
        function printSimple(row) {
             // å‚™ç”¨åˆ—å° (å¦‚æœ JSON è§£æå¤±æ•—)
             document.getElementById('receipt-area').innerHTML = `
                <div style="text-align:center; font-weight:bold;">æ–°è¨‚å–® ${row[0]}</div>
                <div>${row[7]}</div>
                <div style="font-weight:bold; margin-top:10px;">ç¸½é‡‘é¡ï¼š${row[6]}</div>
             `;
             setTimeout(() => window.print(), 500);
        }

        function log(msg) {
            let div = document.getElementById('log-area');
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + div.innerHTML;
        }
    </script>
</body>
</html>
