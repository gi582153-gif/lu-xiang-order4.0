<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»·é¦™é¥Œ - æ¥å–®å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .status-box { border: 1px solid #444; padding: 15px; margin-bottom: 20px; background: #000; }
        .log-area { height: 300px; overflow-y: auto; font-size: 13px; color: #ccc; border-top: 1px dotted #333; padding-top: 10px; }
        button { font-size: 18px; padding: 8px 20px; cursor: pointer; background: #006600; color: white; border: none; }
        
        @media print {
            @page { margin: 0; }
            body { background: white; color: black; margin: 0; padding: 0; width: 100%; }
            .no-print { display: none !important; }
            .receipt { display: block !important; padding: 5px 10px; font-family: 'Noto Sans TC', sans-serif; font-size: 14px; }
            .big-text { font-size: 24px; font-weight: 900; }
            .med-text { font-size: 18px; font-weight: bold; }
            .box-border { border: 2px solid #000; padding: 5px; text-align: center; margin-bottom: 10px; }
            .section { border-bottom: 2px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
            .item { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 4px; }
        }
        .receipt { display: none; } 
    </style>
</head>
<body>

    <div class="no-print">
        <div class="status-box">
            <h2>ğŸ–¨ï¸ æ¥å–®ç›£æ§ç³»çµ± (Flagshipç‰ˆ)</h2>
            <div id="connection-status" style="color:yellow;">ç­‰å¾…å•Ÿå‹•...</div>
            <div>æœ€æ–°å–®è™Ÿï¼š<span id="current-id" style="font-weight:bold; color: white;">--</span></div>
        </div>
        <button onclick="startMonitor()" id="start-btn">â–¶ï¸ å•Ÿå‹•æ¥å–®</button>
        <button onclick="testPrint()" style="background:#555; margin-left:10px;">ğŸ–¨ï¸ æ¸¬è©¦åˆ—å°</button>
        <div class="log-area" id="log-area"></div>
    </div>

    <div id="receipt-area" class="receipt"></div>

    <script>
        // ==========================================
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ ORDERS CSV ç¶²å€
        // ==========================================
        const ordersCsvUrl = "ä½ çš„_ORDERS_CSVç¶²å€"; 
        // ==========================================

        let lastOrderId = localStorage.getItem('lastPrintedId') || "ç„¡";
        let isRunning = false;

        document.getElementById('current-id').innerText = lastOrderId;

        function startMonitor() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('start-btn').innerText = "ğŸŸ¢ ç›£æ§ä¸­";
            document.getElementById('start-btn').style.background = "#004400";
            log("ç³»çµ±å•Ÿå‹•ï¼Œé–‹å§‹é€£æ¥...");
            checkOrders();
            setInterval(checkOrders, 5000);
        }

        function checkOrders() {
            const cacheBusterUrl = ordersCsvUrl + (ordersCsvUrl.includes('?') ? '&' : '?') + "t=" + new Date().getTime();
            Papa.parse(cacheBusterUrl, {
                download: true, header: false,
                complete: function(results) {
                    document.getElementById('connection-status').innerText = "ğŸŸ¢ é€£ç·šæ­£å¸¸";
                    let rows = results.data.filter(r => r && r.length > 0 && r[0] !== '' && r[0] !== 'å–®è™Ÿ');
                    if (rows.length === 0) return;

                    let lastRow = rows[rows.length - 1];
                    let serverId = lastRow[0]; 
                    let jsonStr = lastRow[8]; 

                    if (serverId && serverId !== lastOrderId && serverId.startsWith("#")) {
                        log(`ğŸ”” æ–°è¨‚å–®ï¼š${serverId}`);
                        lastOrderId = serverId;
                        localStorage.setItem('lastPrintedId', serverId);
                        document.getElementById('current-id').innerText = serverId;
                        try {
                            if(jsonStr) printOrder(JSON.parse(jsonStr));
                            else printSimple(lastRow);
                        } catch (e) { printSimple(lastRow); }
                    }
                }
            });
        }

        function printOrder(data) {
            log(`ğŸ–¨ï¸ åˆ—å° ${data.id}...`);
            let typeLabel = data.type === 'å¤–é€' ? 'ğŸ›µ å¤–é€' : 'ğŸ¥¡ è‡ªå–';
            
            let html = `
                <div style="text-align:center; margin-bottom:10px;">
                    <div class="big-text">æ»·é¦™é¥Œ</div>
                    <div style="font-size:12px;">${new Date().toLocaleString()}</div>
                </div>
                
                <div class="box-border">
                    <div class="big-text">${data.id.replace('#','')}</div>
                    <div class="med-text">${typeLabel}</div>
                    <div style="font-size:20px; font-weight:bold;">${data.eta} å–</div>
                </div>

                <div class="section">
                    <div style="font-size:16px; font-weight:bold;">${data.name}</div>
                    <div>${data.phone}</div>
                    ${data.type==='å¤–é€' ? `<div style="font-weight:bold;">ğŸ“ ${data.address}</div>` : ''}
                    <div style="margin-top:5px; border:1px solid #000; padding:2px;">å‚™è¨»ï¼š${data.note || 'ç„¡'}</div>
                </div>
            `;
            
            if(data.subOrders) {
                data.subOrders.forEach((sub, idx) => {
                    html += `<div class="section"><div style="font-weight:bold; background:#eee;">ğŸ‘¤ ç¬¬ ${idx+1} ä½ (${sub.spicy}/${sub.condiment})</div>`;
                    sub.items.forEach(item => {
                        html += `<div class="item"><span>${item.name}</span><span>x${item.qty}</span></div>`;
                    });
                    html += `</div>`;
                });
            }

            html += `
                <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:bold; margin-top:10px;">
                    <span>ç¸½é‡‘é¡</span>
                    <span>$${data.total}</span>
                </div>
                <div style="text-align:center; margin-top:15px; font-size:12px;">
                    * |||| ||||| |||| ||||| *
                </div>
            `;

            document.getElementById('receipt-area').innerHTML = html;
            setTimeout(() => { window.print(); }, 500);
        }

        function printSimple(row) {
             // ç°¡æ˜“ç‰ˆåˆ—å°
             document.getElementById('receipt-area').innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:18px;">æ»·é¦™é¥Œ (ç°¡æ˜“å–®)</div>
                <div style="text-align:center; font-size:24px; border:1px solid #000;">${row[0]}</div>
                <div style="margin-top:10px;">${row[7] ? row[7].replace(/\n/g, '<br>') : 'å…§å®¹è®€å–å¤±æ•—'}</div>
                <div style="font-weight:bold; margin-top:10px; font-size:20px;">ç¸½é‡‘é¡ï¼š${row[6]}</div>
             `;
             setTimeout(() => window.print(), 500);
        }

        function testPrint() {
            printOrder({
                id: "#001", type: "å¤–é€", name: "æ¸¬è©¦å“¡", phone: "0912345678", address: "æ¸¬è©¦è·¯1è™Ÿ",
                eta: "18:30", total: 180, note: "ä¸è¦é¦™èœ",
                subOrders: [{spicy:"å°è¾£", condiment:"é…¸èœ", items:[{name:"å¤§è…¸", qty:2}, {name:"ç±³è¡€", qty:1}]}]
            });
        }
        function log(msg) { document.getElementById('log-area').innerHTML = `<div>${msg}</div>` + document.getElementById('log-area').innerHTML; }
    </script>
</body>
</html>
